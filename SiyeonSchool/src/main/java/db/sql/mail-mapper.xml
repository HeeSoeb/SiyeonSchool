<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>

	<!-- ===================== 메일 개수 조회 ============================= -->

	<!-- 메일함별 메일 개수조회 -->
	<entry key="selectMailboxCountList">
		SELECT 
			   MB.MAILBOX_NO
			 , MB.MAILBOX_NAME
			 , COUNT(MO.MAIL_NO) AS "COUNT"
		  FROM MAIL_OWNER MO
		 RIGHT JOIN MAILBOX MB ON (MO.MAILBOX_NO = MB.MAILBOX_NO)
		 WHERE MB.OWNER_NO = ?
           AND MB.MAILBOX_STATUS = 'Y'
		 GROUP BY (MB.MAILBOX_NO, MB.MAILBOX_NAME)
         ORDER BY
               REGEXP_SUBSTR(MB.MAILBOX_NO, '^[a-zA-Z]+'),
               TO_NUMBER(REGEXP_SUBSTR(MB.MAILBOX_NO, '[0-9]+')) ASC
	</entry>

	<!-- 내메일함별 메일 개수조회 -->
	<entry key="selectPrivateMailboxCountList">
		SELECT 
			    MB.MAILBOX_NO
			  , MB.MAILBOX_NAME
			  , (SELECT COUNT(MO.MAILBOX_NO) 
			       FROM MAIL_OWNER MO 
			      WHERE MO.MAILBOX_NO = MB.MAILBOX_NO 
			        AND MO.MAIL_STATUS = 'Y') AS "COUNT"
		   FROM MAILBOX MB
		  WHERE MB.OWNER_NO = ?
			AND MB.MAILBOX_TYPE = 'P'
			AND MB.MAILBOX_STATUS = 'Y'
	</entry>

	<!-- 않읽은메일 개수조회-->
	<entry key="selectUnreadMailCount">
		SELECT COUNT(MAIL_NO) AS "COUNT"
		  FROM MAIL_RECEIVER
		 WHERE RECEIVER_NO = ?
		   AND MAIL_NO IN (SELECT MAIL_NO
		                     FROM MAIL
		                    WHERE IS_SENT = 'S')
		   AND READ_TIME IS NULL
	</entry>
	
	<!-- 중요메일 개수조회 -->
	<entry key="selectImportantMailCount">
		SELECT COUNT(MO.MAIL_NO) AS "COUNT"
		  FROM MAIL_OWNER MO
          JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
		 WHERE MO.OWNER_NO = ?
		   AND MO.MAIL_STAR = 'Y'
		   AND MO.MAIL_STATUS = 'Y'
           AND M.IS_SENT = 'S'
	</entry>
	


	<!-- ===================== 메일 목록 조회 ============================= -->

	<!-- 전체메일함 메일목록 조회 -->
	<entry key="selectAllMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT
							   MO.MAIL_NO
							 , MB.MAILBOX_NAME
							 , MO.MAIL_STAR
                             , NVL2(MR.READ_TIME, 'Y', 'N') AS "IS_READ"
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
                             , U.USER_NAME
                             , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
							 , M.MAIL_TITLE
							 , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
                          JOIN MAIL_RECEIVER MR ON (MO.MAIL_NO = MR.MAIL_NO) AND (MO.OWNER_NO = MR.RECEIVER_NO)
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN MAILBOX MB ON (MO.MAILBOX_NO = MB.MAILBOX_NO)
                          JOIN USERS U ON (M.SENDER = U.USER_NO)
						  JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
                                        FROM ATTACHMENT
                                       WHERE STATUS = 'Y'
                                       GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
						 WHERE MO.OWNER_NO = ?
						   AND MO.MAIL_STATUS = 'Y'
						   AND M.IS_SENT = 'S'
						 ORDER
							BY SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>

	<!-- 받은메일함 메일목록 조회 -->
	<entry key="selectInboxMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT
						       MO.MAIL_NO
						     , MO.MAIL_STAR
						     , NVL2(MR.READ_TIME, 'Y', 'N') AS "IS_READ"
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
						     , U.USER_NAME
						     , U.USER_ID
						     , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
						     , M.MAIL_TITLE
						     , DECODE(MR.RECEIVER_TYPE, 'R', '수신', 'C', '참조', 'S', '비밀') AS "RECEIVER_TYPE"
						     , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
						  JOIN MAIL_RECEIVER MR ON (MO.MAIL_NO = MR.MAIL_NO) AND (MO.OWNER_NO = MR.RECEIVER_NO)
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN USERS U ON (M.SENDER = U.USER_NO)
						  LEFT JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
                                        FROM ATTACHMENT
                                       WHERE STATUS = 'Y'
                                       GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
						 WHERE MO.MAILBOX_NO = (SELECT MAILBOX_NO
						                          FROM MAILBOX
						                         WHERE OWNER_NO = ?
						                           AND MAILBOX_NAME = '받은메일함')
						   AND MO.MAIL_STATUS = 'Y'
						   AND M.IS_SENT = 'S'
						 ORDER
						    BY M.SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>

	<!-- 보낸메일함 메일목록 조회 -->
	<entry key="selectSentMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT
							   MO.MAIL_NO
							 , MO.MAIL_STAR
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
							 , U.USER_NAME
							 , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
							 , M.MAIL_TITLE
							 , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						FROM MAIL_OWNER MO
						JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						JOIN USERS U ON (M.SENDER = U.USER_NO)
						JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                        LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
								      FROM ATTACHMENT
							         WHERE STATUS = 'Y'
							         GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
					   WHERE MAILBOX_NO = ( SELECT MAILBOX_NO
											 FROM MAILBOX
											 WHERE OWNER_NO = ?
											 AND MAILBOX_NAME = '보낸메일함' )
						 AND MO.MAIL_STATUS = 'Y'
						 AND M.IS_SENT = 'S'OR  M.IS_SENT = 'C'
					   ORDER
					      BY M.SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- 임시보관함 메일목록 조회 -->
	<entry key="selectTempMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
                    	SELECT 
						  	   MO.MAIL_NO
						     , MO.MAIL_STAR
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
						     , U.USER_NAME
							 , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
						     , M.MAIL_TITLE
						     , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN USERS U ON (M.SENDER = U.USER_NO)
						  JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
										FROM ATTACHMENT
									   WHERE STATUS = 'Y'
									   GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
					     WHERE MO.MAILBOX_NO = (SELECT MAILBOX_NO
							                      FROM MAILBOX
							                     WHERE OWNER_NO = ?
							                       AND MAILBOX_NAME = '임시보관함')
						   AND MO.MAIL_STATUS = 'Y'
						   AND M.IS_SENT = 'T'
				         ORDER
				            BY M.SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- 내게쓴메일함 메일목록 조회 -->
	<entry key="selectToMyselfMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT 
						  	   MO.MAIL_NO
						     , MO.MAIL_STAR
                             , NVL2(MR.READ_TIME, 'Y', 'N') AS "IS_READ"
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
						     , U.USER_NAME
							 , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
						     , M.MAIL_TITLE
						     , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
                          JOIN MAIL_RECEIVER MR ON (MO.MAIL_NO = MR.MAIL_NO) AND (MO.OWNER_NO = MR.RECEIVER_NO)
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN USERS U ON (M.SENDER = U.USER_NO)
						  JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
                                        FROM ATTACHMENT
                                       WHERE STATUS = 'Y'
                                       GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
					     WHERE MO.MAILBOX_NO = (SELECT MAILBOX_NO
							                      FROM MAILBOX
							                     WHERE OWNER_NO = ?
							                       AND MAILBOX_NAME = '내게쓴메일함')
						   AND MO.MAIL_STATUS = 'Y'
						   AND M.IS_SENT = 'S'
				         ORDER
				            BY M.SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- 휴지통 메일목록 조회 -->
	<entry key="selectBinMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT 
						  	   MO.MAIL_NO
						     , MO.MAIL_STAR
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
						     , U.USER_NAME
							 , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
						     , M.MAIL_TITLE
						     , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN USERS U ON (M.SENDER = U.USER_NO)
						  JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
										FROM ATTACHMENT
									   WHERE STATUS = 'Y'
									   GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
					     WHERE MO.MAILBOX_NO = (SELECT MAILBOX_NO
							                      FROM MAILBOX
							                     WHERE OWNER_NO = ?
							                       AND MAILBOX_NAME = '휴지통')
						   AND MO.MAIL_STATUS = 'N'
				         ORDER
				            BY M.SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- 안읽은메일 목록 조회 -->
	<entry key="selectUnreadMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT 
						       MR.MAIL_NO
						     , MO.MAIL_STAR
						     , NVL2(MR.READ_TIME, 'Y', 'N') AS "IS_READ"
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
						     , U.USER_NAME
							 , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
						     , M.MAIL_TITLE
						     , DECODE(MR.RECEIVER_TYPE, 'R', '수신', 'C', '참조', 'S', '비밀') AS "RECEIVER_TYPE"
						     , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_RECEIVER MR
						  JOIN MAIL M ON (MR.MAIL_NO = M.MAIL_NO)
						  JOIN MAIL_OWNER MO ON (MR.MAIL_NO = MO.MAIL_NO) AND (MR.RECEIVER_NO = MO.OWNER_NO)
						  JOIN USERS U ON M.SENDER = U.USER_NO
						  LEFT JOIN ATTACHMENT A ON U.PROFILE_FILE_NO = A.FILE_NO
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
                                        FROM ATTACHMENT
                                       WHERE STATUS = 'Y'
                                       GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
						 WHERE MR.RECEIVER_NO = ?
						   AND MR.READ_TIME IS NULL
   						 ORDER
						    BY M.SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- 중요메일 목록 조회 -->
	<entry key="selectImportantMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
                        SELECT
							   MO.MAIL_NO
							 , MB.MAILBOX_NAME
						     , MO.MAIL_STAR
                             , CASE WHEN MAILBOX_NAME = '보낸메일함' THEN 'Y'
                                    WHEN MR.READ_TIME IS NOT NULL THEN 'Y'
                                    ELSE 'N'
                               END AS "IS_READ"
                             , NVL(AC.COUNT, 0) AS "ATT_COUNT"
							 , U.USER_NAME
						     , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
							 , M.MAIL_TITLE
							 , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN MAILBOX MB ON (MO.MAILBOX_NO = MB.MAILBOX_NO)
                          LEFT JOIN MAIL_RECEIVER MR ON (MO.MAIL_NO = MR.MAIL_NO) AND (MO.OWNER_NO = MR.RECEIVER_NO)
						  JOIN USERS U ON (M.SENDER = U.USER_NO)
						  JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
                          LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
                                        FROM ATTACHMENT
                                       WHERE STATUS = 'Y'
                                       GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
						 WHERE MO.OWNER_NO = ?
						   AND MO.MAIL_STAR = 'Y'
						   AND MO.MAIL_STATUS = 'Y'
						   AND M.IS_SENT = 'S'
						 ORDER
						    BY SEND_DATE DESC
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- 내메일함별 메일목록 조회: 메일함번호 필요 -->
	<entry key="selectPrivateMailboxMailList">
		SELECT *
		  FROM (
			     SELECT ROWNUM RNUM, A.*
			     FROM (
						SELECT 
							   MO.MAIL_NO
							 , MO.MAIL_STAR
							 , NVL2(MR.READ_TIME, 'Y', 'N') AS "IS_READ"
							 , NVL(AC.COUNT, 0) AS "ATT_COUNT"
							 , U.USER_NAME
							 , U.USER_ID
							 , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
							 , M.MAIL_TITLE
							 , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
						  FROM MAIL_OWNER MO
						  JOIN MAIL M ON (MO.MAIL_NO = M.MAIL_NO)
						  JOIN MAIL_RECEIVER MR ON (MO.OWNER_NO = MR.RECEIVER_NO) AND (MO.MAIL_NO = MR.MAIL_NO)
						  JOIN USERS U ON (M.SENDER = U.USER_NO)
						  JOIN ATTACHMENT A ON (U.PROFILE_FILE_NO = A.FILE_NO)
						  LEFT JOIN ( SELECT REF_BNO AS MAIL_NO, COUNT(FILE_NO) AS COUNT
										FROM ATTACHMENT
									   WHERE STATUS = 'Y'
									   GROUP BY REF_BNO ) AC ON (MO.MAIL_NO = AC.MAIL_NO)
						 WHERE MO.MAILBOX_NO = ?
						   AND MO.MAIL_STATUS = 'Y'
			          ) A
		  		)
		  WHERE RNUM BETWEEN ? AND ?
	</entry>
	
	<!-- ===================== 메일 상세 조회 ============================= -->
	
	<!-- 메일 상세 조회 : 사용자번호, 메일번호 필요 -->
	<entry key="selectMail">
		SELECT 
		       M.MAIL_NO
             , MO.MAIL_STAR
             , M.MAIL_TITLE
		     , U1.USER_NAME
		     , U1.USER_ID
		     , A.FILE_PATH || A.CHANGE_NAME AS "PROFILE_PATH"
             , TO_CHAR(M.SEND_DATE, 'YYYY-MM-DD (DY) HH24:MI') AS "SEND_DATE"
		     , M.MAIL_CONTENT
		FROM MAIL M
        JOIN MAIL_OWNER MO ON (MO.OWNER_NO = ?) AND (M.MAIL_NO = MO.MAIL_NO)
		JOIN USERS U1 ON (M.SENDER = U1.USER_NO)
		JOIN ATTACHMENT A ON (U1.PROFILE_FILE_NO = A.FILE_NO)
		WHERE M.MAIL_NO = ?
	</entry>
	
	<!-- 메일 수신인 조회 : 메일번호 필요 -->
	<entry key="selectMailReceiverList">
		SELECT
		       MR.MAIL_NO
		     , MR.RECEIVER_NO
		     , U.USER_NAME
		     , U.USER_ID
		     , DECODE(MR.RECEIVER_TYPE, 'R', '수신', 'C', '참조', 'S', '비밀') AS "RECEIVER_TYPE"
		     , NVL(TO_CHAR(MR.READ_TIME, 'YYYY-MM-DD (DY) HH24:MI'), '읽지않음') AS "READ_TIME"
		FROM MAIL_RECEIVER MR
		JOIN USERS U ON (MR.RECEIVER_NO = U.USER_NO)
		WHERE MR.MAIL_NO = ?
		ORDER
		   BY U.USER_NAME ASC
	</entry>
	
	<!-- 메일 수신인타입(R:수신/C:참조/S:비밀) 카운트 조회 : 메일번호 필요 -->
	<entry key="selectMailReceiverTypeCount">
		SELECT 
			   CASE 
			   		WHEN RECEIVER_TYPE IS NULL THEN 'TOTAL'
			        ELSE RECEIVER_TYPE
			    END AS RECEIVER_TYPE,
			    COUNT(RECEIVER_TYPE) AS COUNT
		  FROM MAIL_RECEIVER
		 WHERE MAIL_NO = ?
		 GROUP
		    BY ROLLUP(RECEIVER_TYPE)
	</entry>
	
	<!-- 메일 첨부파일 조회 : 메일번호 필요 -->
	<entry key="selectAttachmentList">
		SELECT
		       FILE_NO
		     , ORIGIN_NAME
		     , CHANGE_NAME
		     , FILE_PATH
		FROM ATTACHMENT
		WHERE REF_BNO = ?
		AND STATUS = 'Y'
	</entry>
	
	<!-- ===================== 별 수정 ============================= -->
	<!-- 별 수정 -->
	<entry key="updateStar">
		UPDATE MAIL_OWNER
		   SET MAIL_STAR = ?
		 WHERE OWNER_NO = ?
		   AND MAIL_NO = ?
	</entry>
	
	<!-- ===================== 읽음 수정 ============================= -->
	
	<!-- 읽음 여부 조회 -->
	<entry key="selectIsRead">
		SELECT NVL2(READ_TIME, 'Y', 'N') AS "IS_READ"
		  FROM MAIL_RECEIVER
		 WHERE RECEIVER_NO = ?
		   AND MAIL_NO = ?
	</entry>
	
	<!-- 읽음 수정 - NULL -->
	<entry key="updateReadToNull">
		UPDATE MAIL_RECEIVER
		   SET READ_TIME = NULL
		 WHERE RECEIVER_NO = ?
		   AND MAIL_NO = ?
	</entry>
	
	<!-- 읽음 수정 - SYSDATE -->
	<entry key="updateReadToSysdate">
		UPDATE MAIL_RECEIVER
		   SET READ_TIME = SYSDATE
		 WHERE RECEIVER_NO = ?
		   AND MAIL_NO = ?
	</entry>
	
</properties>